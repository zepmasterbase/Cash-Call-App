<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Pay — CashCall</title>
  <meta name="description" content="Secure card payments for CashCall requests. Shows fee breakdown (2%)." />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Manrope:wght@600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --maxw:420px;
      --bg-1:#eef6fb;
      --bg-2:#ffffff;
      --card:#ffffff;
      --muted:#546b76;
      --accent-a:#00bcd4;
      --accent-b:#8450ff;
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;padding:0;background:linear-gradient(180deg,var(--bg-1),var(--bg-2));font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;color:#06202b}
    body{ padding:18px; -webkit-font-smoothing:antialiased }
    .wrap{ max-width:var(--maxw); margin:0 auto }
    header{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px; border-radius:12px; background:rgba(255,255,255,0.95); border:1px solid rgba(7,32,44,0.06); box-shadow:0 8px 30px rgba(7,30,60,0.04); position:sticky; top:12px; z-index:30 }
    .brand { display:flex; gap:10px; align-items:center }
    .logo { width:44px;height:44px;border-radius:10px;display:grid;place-items:center;background:linear-gradient(90deg,var(--accent-a),var(--accent-b)); color:#021026; font-weight:900; font-family:Manrope }
    .title { font-family:Manrope; font-weight:800; font-size:16px; margin:0 }
    main{ margin-top:12px; display:grid; gap:12px }

    .card{ background:var(--card); border-radius:14px; padding:14px; border:1px solid rgba(7,32,44,0.04); box-shadow:0 20px 50px rgba(7,30,60,0.04) }
    .label { color:var(--muted); font-size:13px; margin-bottom:6px }
    .big { font-family:Manrope; font-size:28px; font-weight:800; color:#021026 }
    .desc { color:var(--muted); margin-top:6px; font-size:14px }

    .fee-row { display:flex; justify-content:space-between; gap:12px; padding:10px 12px; border-radius:10px; background:linear-gradient(180deg,#fbfdff,#ffffff); border:1px solid rgba(7,32,44,0.03); margin-top:10px; }
    .fee-row b { font-weight:800 }
    .muted { color:var(--muted); font-size:13px }

    .actions { display:flex; gap:10px; margin-top:14px }
    .btn { flex:1; padding:12px; border-radius:12px; border:0; font-weight:800; cursor:pointer }
    .btn-primary { background:linear-gradient(90deg,var(--accent-a),var(--accent-b)); color:#021026; box-shadow:0 12px 30px rgba(7,30,60,0.06) }
    .btn-ghost { background:transparent; border:1px solid rgba(7,32,44,0.06); color:var(--muted); font-weight:700 }

    .notice { margin-top:12px; font-size:13px; color:var(--muted) }
    .status { margin-top:12px; padding:10px; border-radius:10px; display:none; font-weight:700 }
    .status.success { display:block; color:#0a7a3c; background:rgba(10,122,60,0.06); border:1px solid rgba(10,122,60,0.06) }
    .status.error { display:block; color:#b42318; background:rgba(180,35,24,0.06); border:1px solid rgba(180,35,24,0.06) }

    .spinner { display:inline-block; width:14px; height:14px; border-radius:50%; border:2px solid rgba(255,255,255,0.6); border-right-color:rgba(0,0,0,0.12); animation:spin .9s linear infinite; vertical-align:middle; margin-left:8px }
    @keyframes spin { to { transform:rotate(360deg) } }

    .small { font-size:13px; color:var(--muted) }

    @media (max-width:380px){ .big{ font-size:24px } .fee-row{ padding:10px } .actions{ flex-direction:column } .btn{ width:100% } }
  </style>
</head>
<body>
  <div class="wrap" role="document">
    <header role="banner" aria-label="Top">
      <div class="brand">
        <div class="logo" aria-hidden="true">C</div>
        <div>
          <p class="title">CashCall</p>
          <p id="payeeLabel" class="small" style="margin:0"></p>
        </div>
      </div>

      <nav>
        <a class="small" href="dashboard.html">Dashboard</a>
      </nav>
    </header>

    <main>
      <section class="card" aria-labelledby="payHeading">
        <h2 id="payHeading" style="margin:0;font-family:Manrope;font-size:18px">Complete payment</h2>
        <div id="statusNote" class="label" style="margin-top:6px">Loading request…</div>

        <div id="requestBlock" style="display:none">
          <div class="label">Request from</div>
          <div id="requestorName" class="small" style="margin-bottom:8px">—</div>

          <div class="label">Amount</div>
          <div id="amountGross" class="big">—</div>
          <div id="amountSub" class="small">—</div>

          <div id="description" class="desc">—</div>

          <!-- fee breakdown -->
          <div class="fee-row" aria-live="polite" aria-atomic="true" style="margin-top:14px">
            <div>
              <div class="small">Platform fee (2%)</div>
              <div id="feeAmount" style="font-weight:800">—</div>
            </div>
            <div style="text-align:right">
              <div class="small">Net to payee</div>
              <div id="netAmount" style="font-weight:800">—</div>
            </div>
          </div>

          <div class="actions">
            <button id="payBtn" class="btn btn-primary" aria-live="polite">Pay with card</button>
            <button id="copyBtn" class="btn btn-ghost">Copy link</button>
          </div>

          <div id="afterMsg" class="notice" aria-live="polite"></div>
          <div id="statusBox" class="status" role="status" aria-live="polite"></div>
        </div>

      </section>

      <section class="card">
        <p class="small" style="margin:0"><strong>How fees work</strong> — A 2% platform fee is deducted from the gross amount when payment settles. The server is the source of truth — it will calculate and persist final fee & net amounts.</p>
      </section>

      <div class="small" style="text-align:center; margin-top:8px">Powered by your payment provider</div>
    </main>
  </div>

  <!-- Paystack inline script -->
  <script src="https://js.paystack.co/v1/inline.js"></script>

  <script>
    /**************************************************************************
     * pay.html (complete frontend)
     *
     * - Shows fee breakdown (2%) calculated using integer math (smallest units)
     * - Initiates payment via POST /api/payments/initiate { requestId }
     * - If server returns authorization_url => redirect
     * - If server returns reference + publicKey => inline Paystack popup
     * - After pay, POST /api/payments/verify { reference } to verify and finalize
     *
     * IMPORTANT:
     * - This page displays fee info for UX only. Server must calculate and store real fees.
     * - Always verify payments server-side (webhook + verify endpoints).
     **************************************************************************/

    // Config / endpoints
    const REQUESTS_KEY = 'cashcall_requests';           // local fallback
    const GET_REQUEST_ENDPOINT = id => `/api/requests/${encodeURIComponent(id)}`; // server authoritative
    const INITIATE_ENDPOINT = '/api/payments/initiate'; // POST { requestId }
    const VERIFY_ENDPOINT = '/api/payments/verify';     // POST { reference }

    // DOM
    const statusNote = document.getElementById('statusNote');
    const requestBlock = document.getElementById('requestBlock');
    const requestorName = document.getElementById('requestorName');
    const amountGross = document.getElementById('amountGross');
    const amountSub = document.getElementById('amountSub');
    const descriptionEl = document.getElementById('description');
    const feeAmountEl = document.getElementById('feeAmount');
    const netAmountEl = document.getElementById('netAmount');
    const payBtn = document.getElementById('payBtn');
    const copyBtn = document.getElementById('copyBtn');
    const afterMsg = document.getElementById('afterMsg');
    const statusBox = document.getElementById('statusBox');
    const payeeLabel = document.getElementById('payeeLabel');

    // small utility: parse query string
    function qs(name) { return new URLSearchParams(location.search).get(name); }

    // safe integer math: convert to smallest units (cents/kobo)
    // input: amount string or number in major unit (e.g. "1000.50")
    // returns integer smallest units
    function toSmallestUnit(amount) {
      // ensure numeric string, handle decimals
      // multiply by 100 and round to integer
      const n = typeof amount === 'number' ? amount : parseFloat(String(amount).replace(/,/g,''));
      if (isNaN(n)) return 0;
      return Math.round(n * 100);
    }

    function fromSmallestUnit(amountSmall, currency) {
      // amountSmall is integer (kobo/cents)
      const major = (Number(amountSmall) / 100).toFixed(2);
      try {
        return new Intl.NumberFormat(undefined, { style:'currency', currency }).format(Number(major));
      } catch (err) {
        return (currency ? currency + ' ' : '') + major;
      }
    }

    // fee calculation: 2% platform fee
    function calculateFee(grossSmall) {
      // feeSmall = round(grossSmall * 0.02)
      // compute with integers: feeSmall = Math.round(grossSmall * 2 / 100)
      return Math.round(grossSmall * 2 / 100);
    }

    // escape small strings for insertion
    function escapeHtml(s) {
      if (!s) return '';
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // fetch request (server preferred, fallback to localStorage)
    async function loadRequest(requestId) {
      if (!requestId) return null;
      // try server
      try {
        const resp = await fetch(GET_REQUEST_ENDPOINT(requestId), { method:'GET', credentials: 'include' });
        if (resp.ok) {
          const json = await resp.json();
          if (json && json.id) return json;
        }
      } catch (err) {
        console.warn('Server fetch failed, falling back to localStorage', err);
      }
      // fallback localStorage
      try {
        const arr = JSON.parse(localStorage.getItem(REQUESTS_KEY) || '[]');
        return arr.find(r => r.id === requestId) || null;
      } catch (err) {
        return null;
      }
    }

    // render request & fee breakdown
    function renderRequest(req) {
      requestorName.textContent = req.requestorName || req.requestor || req.payee || 'Requester';
      descriptionEl.textContent = req.description || 'Payment request';
      payeeLabel.textContent = req.payee || '';
      // amount might be stored as string/number in major units
      const grossSmall = req.amount_small != null ? Number(req.amount_small) : toSmallestUnit(req.amount);
      const currency = req.currency || 'USD';

      const feeSmall = calculateFee(grossSmall);
      const netSmall = grossSmall - feeSmall;

      amountGross.textContent = fromSmallestUnit(grossSmall, currency);
      amountSub.textContent = `${currency} ${Number(grossSmall/100).toFixed(2)} • ${req.note || ''}`;

      feeAmountEl.textContent = fromSmallestUnit(feeSmall, currency);
      netAmountEl.textContent = fromSmallestUnit(netSmall, currency);

      // show UI
      statusNote.textContent = 'Ready to pay — secure checkout';
      requestBlock.style.display = 'block';

      // disable pay button if already paid
      if (req.status === 'paid' || req.paid === true) {
        payBtn.disabled = true;
        statusBox.className = 'status success';
        statusBox.textContent = 'This request has already been paid.';
      }
    }

    // mark request paid locally (best-effort)
    function markRequestPaidLocal(requestId, reference) {
      try {
        const arr = JSON.parse(localStorage.getItem(REQUESTS_KEY) || '[]');
        const idx = arr.findIndex(r => r.id === requestId);
        if (idx !== -1) {
          arr[idx].status = 'paid';
          arr[idx].paidAt = new Date().toISOString();
          arr[idx].paymentReference = reference;
          localStorage.setItem(REQUESTS_KEY, JSON.stringify(arr));
        }
      } catch (err) {
        console.warn('mark local paid failed', err);
      }
    }

    // Initiate payment (call your backend). Expect JSON response.
    // Server should initialize Paystack transaction using secret key and return:
    // - { authorization_url } OR
    // - { reference, publicKey, amount } for inline
    async function initiatePayment(requestId) {
      const resp = await fetch(INITIATE_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ requestId }),
        credentials: 'include'
      });
      if (!resp.ok) {
        const txt = await resp.text().catch(()=>null);
        throw new Error(txt || `Init failed (${resp.status})`);
      }
      return resp.json();
    }

    // Verify payment (server verifies with Paystack secret key)
    async function verifyPayment(reference) {
      const resp = await fetch(VERIFY_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ reference }),
        credentials: 'include'
      });
      if (!resp.ok) {
        const txt = await resp.text().catch(()=>null);
        throw new Error(txt || `Verify failed (${resp.status})`);
      }
      return resp.json();
    }

    // main
    (async function init() {
      const requestId = qs('request_id');
      if (!requestId) {
        statusNote.textContent = 'Invalid link: missing request id.';
        return;
      }

      statusNote.textContent = 'Fetching request…';
      const req = await loadRequest(requestId);
      if (!req) {
        statusNote.textContent = 'Request not found or expired. Ask requester to resend.';
        return;
      }

      // Normalize amount: prefer "amount_small" (integer) if server provided it; else rely on "amount" major
      // If request came from server, it might include amount_small (smallest units). If not, treat amount as major.
      // Ensure req.amount exists for fallback display.
      if (req.amount == null && req.amount_small != null) {
        req.amount = (Number(req.amount_small) / 100).toFixed(2);
      }

      renderRequest(req);

      // button handlers
      copyBtn.addEventListener('click', async () => {
        const link = location.href;
        try {
          await navigator.clipboard.writeText(link);
          afterMsg.textContent = 'Link copied to clipboard';
        } catch (err) {
          prompt('Copy this link', link);
        }
      });

      payBtn.addEventListener('click', async () => {
        payBtn.disabled = true;
        payBtn.innerHTML = 'Preparing… <span class="spinner" aria-hidden="true"></span>';
        statusBox.style.display = 'none';
        afterMsg.textContent = '';

        try {
          const init = await initiatePayment(req.id);

          // server returned an authorization_url -> redirect flow
          if (init.authorization_url) {
            statusNote.textContent = 'Redirecting to secure payment page…';
            window.location.href = init.authorization_url;
            return;
          }

          // inline flow: require publicKey + reference
          const publicKey = init.publicKey || init.public_key || init.pk;
          const reference = init.reference || init.ref || init.access_code;
          // server may return amount in smallest units (init.amount) or not
          const amountSmall = init.amount || req.amount_small || toSmallestUnit(req.amount);
          const email = init.email || req.payee || (init.customer_email || 'customer@example.com');

          if (!publicKey || !reference) {
            throw new Error('Payment initialization did not return inline config (publicKey/reference).');
          }

          if (!window.PaystackPop) throw new Error('Payment library not loaded.');

          statusNote.textContent = 'Opening secure card entry…';

          const handler = PaystackPop.setup({
            key: publicKey,
            email: email,
            amount: Number(amountSmall), // amount in smallest unit
            ref: reference,
            metadata: { requestId: req.id },
            callback: async function(response) {
              // response.reference present
              statusNote.textContent = 'Payment complete — verifying…';
              payBtn.innerHTML = 'Verifying… <span class="spinner" aria-hidden="true"></span>';
              try {
                const verifyResult = await verifyPayment(response.reference);
                // Expect server to return verification status (success)
                // server might return { success:true, data:{ status:'success', ... } }
                const ok = (verifyResult && (verifyResult.success === true || verifyResult.data?.status === 'success' || verifyResult.status === 'success'));
                if (ok) {
                  markRequestPaidLocal(req.id, response.reference);
                  statusBox.className = 'status success';
                  statusBox.textContent = 'Payment successful. Thank you!';
                  afterMsg.textContent = `Reference: ${escapeHtml(response.reference)}`;
                  // Optionally redirect to dashboard after short delay
                  setTimeout(() => window.location.href = 'dashboard.html', 1100);
                } else {
                  throw new Error((verifyResult && (verifyResult.message || JSON.stringify(verifyResult))) || 'Verification failed');
                }
              } catch (err) {
                console.error('verify error', err);
                statusBox.className = 'status error';
                statusBox.textContent = 'Payment verification failed. Contact support.';
                afterMsg.textContent = (err.message || err).toString();
              } finally {
                payBtn.disabled = false;
                payBtn.textContent = 'Pay with card';
              }
            },
            onClose: function() {
              payBtn.disabled = false;
              payBtn.textContent = 'Pay with card';
              statusNote.textContent = 'Payment cancelled. You can try again or copy the link.';
            }
          });

          handler.openIframe();

        } catch (err) {
          console.error('initiate error', err);
          statusBox.className = 'status error';
          statusBox.textContent = 'Unable to start payment: ' + (err.message || err);
          payBtn.disabled = false;
          payBtn.textContent = 'Pay with card';
          statusNote.textContent = 'Try again or contact support.';
        }
      }); // end payBtn click
    })();
  </script>
</body>
</html>