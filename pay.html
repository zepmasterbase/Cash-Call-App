<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Pay by Scan — CashCall</title>
  <meta name="description" content="Scan a peer QR and deduct from their CashCall in-app balance (demo front-end). Server-side verification required." />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Manrope:wght@600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --maxw:420px;
      --bg:#f6fbff;
      --card:#ffffff;
      --muted:#5b737f;
      --accent-a:#00bcd4;
      --accent-b:#8450ff;
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;padding:0;background:linear-gradient(180deg,var(--bg),#fff);font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;color:#06202b}
    body{ padding:18px; -webkit-font-smoothing:antialiased; -webkit-text-size-adjust:100% }
    .wrap{ max-width:var(--maxw); margin:0 auto; }

    header{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px; border-radius:12px; background:rgba(255,255,255,0.95); border:1px solid rgba(7,32,44,0.06); box-shadow:0 12px 30px rgba(7,30,60,0.04); }
    .logo { width:44px;height:44px;border-radius:10px;display:grid;place-items:center;background:linear-gradient(90deg,var(--accent-a),var(--accent-b)); color:#021026; font-weight:900; font-family:Manrope }
    .title { font-family:Manrope; font-weight:800; font-size:16px; margin:0 }

    main{ margin-top:12px; display:grid; gap:12px }

    .card{ background:var(--card); border-radius:14px; padding:14px; border:1px solid rgba(7,32,44,0.04); box-shadow:0 16px 40px rgba(7,30,60,0.04) }
    label{ display:block; font-weight:700; color:#274048; font-size:13px; margin-bottom:6px }
    input, select { width:100%; padding:12px; border-radius:10px; border:1px solid rgba(7,32,44,0.06); font-size:15px; background:transparent; color:#06202b }
    .row { display:flex; gap:8px; }
    .col { flex:1 }

    .big { font-family:Manrope; font-size:28px; font-weight:800; color:#021026; margin:6px 0; }

    .scan-area {
      margin-top:12px;
      border-radius:12px;
      overflow:hidden;
      position:relative;
      background: #000;
      min-height:280px;
      display:grid;
      place-items:center;
    }
    video#cameraView { width:100%; height:auto; object-fit:cover; display:block; transform:scaleX(-1); } /* mirror for user convenience */

    canvas#captureCanvas { display:none }

    .controls { display:flex; gap:10px; margin-top:12px; }
    .btn { flex:1; padding:12px; border-radius:12px; border:0; font-weight:800; cursor:pointer }
    .btn-primary { background:linear-gradient(90deg,var(--accent-a),var(--accent-b)); color:#021026 }
    .btn-ghost { background:transparent; border:1px solid rgba(7,32,44,0.06); color:var(--muted); font-weight:700 }

    .info { margin-top:12px; color:var(--muted); font-size:13px }
    .fee-row { display:flex; justify-content:space-between; gap:12px; padding:10px; margin-top:10px; border-radius:10px; background:linear-gradient(180deg,#fbfdff,#ffffff); border:1px solid rgba(7,32,44,0.03) }
    .status { margin-top:10px; padding:10px; border-radius:10px; display:none; font-weight:700 }
    .status.ok { display:block; color:#0a7a3c; background:rgba(10,122,60,0.06); border:1px solid rgba(10,122,60,0.06) }
    .status.err { display:block; color:#b42318; background:rgba(180,35,24,0.06); border:1px solid rgba(180,35,24,0.06) }

    .small { font-size:13px; color:var(--muted) }

    @media (max-width:380px) {
      .big { font-size:22px }
      .scan-area { min-height:240px }
      .controls { flex-direction:column }
    }
  </style>

  <!-- jsQR fallback for browsers without BarcodeDetector -->
  <script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
</head>
<body>
  <div class="wrap" role="document">
    <header>
      <div style="display:flex;gap:12px;align-items:center">
        <div class="logo" aria-hidden="true">C</div>
        <div>
          <p class="title">CashCall — Pay by scan</p>
          <p class="small" style="margin:0">Scan peer QR to debit their in-app balance</p>
        </div>
      </div>
      <nav><a class="small" href="dashboard.html">Dashboard</a></nav>
    </header>

    <main>
      <!-- Amount / currency -->
      <section class="card">
        <label for="amount">Amount to transfer</label>
        <input id="amount" type="number" step="0.01" min="0.01" placeholder="e.g. 1000.00">

        <label for="currency" style="margin-top:8px">Currency</label>
        <select id="currency">
          <option value="NGN">NGN</option>
          <option value="ZAR">ZAR</option>
          <option value="GHS">GHS</option>
          <option value="USD">USD</option>
        </select>

        <div class="fee-row" aria-live="polite">
          <div><div class="small">Platform fee (2%)</div></div>
          <div>
            <div id="feeDisplay" style="font-weight:800">—</div>
          </div>
        </div>

        <div style="margin-top:10px">
          <label class="small">Scanner</label>
          <div class="scan-area" id="scanArea" aria-hidden="false">
            <video id="cameraView" playsinline></video>
            <canvas id="captureCanvas"></canvas>
            <div id="scanOverlay" style="position:absolute;inset:0;display:grid;place-items:center;pointer-events:none">
              <div style="color:rgba(255,255,255,0.9); font-weight:700; background:rgba(0,0,0,0.25); padding:6px 10px; border-radius:8px">Point the peer's QR here</div>
            </div>
          </div>
        </div>

        <div class="controls">
          <button id="startScan" class="btn btn-primary">Open camera & scan</button>
          <button id="stopScan" class="btn btn-ghost" disabled>Stop</button>
        </div>

        <div id="scanStatus" class="info" aria-live="polite">Scanner idle</div>
      </section>

      <!-- Scanned peer info & confirm -->
      <section class="card" id="peerCard" style="display:none">
        <div class="small">Peer</div>
        <div id="peerId" style="font-weight:800; margin-top:6px">—</div>
        <div id="peerBalance" class="small" style="margin-top:6px">—</div>

        <div style="margin-top:10px">
          <label class="small">Gross amount</label>
          <div id="grossDisplay" class="big">—</div>
          <div class="small" id="netDisplay">—</div>
        </div>

        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="confirmBtn" class="btn btn-primary">Confirm & Deduct</button>
          <button id="cancelBtn" class="btn btn-ghost">Cancel</button>
        </div>

        <div id="actionStatus" class="status" role="status" aria-live="polite"></div>
        <div class="info" style="margin-top:8px">Server will verify token and perform the ledger changes. This demo sends a request to <code>/api/payments/peer-deduct</code>.</div>
      </section>

    </main>
  </div>

  <script>
    /************************************************************************
     * pay.html (camera scan -> deduct peer wallet) - Frontend only
     *
     * Flow:
     * 1. User inputs amount & currency.
     * 2. User opens camera and points at peer's QR (peer displays their QR in-app).
     * 3. QR must contain either:
     *    - cashcall://pay?userId=USER123&balance_small=12345&token=abc...
     *    - OR JSON: {"userId":"USER123", "balance_small":12345, "token":"abc..."}
     * 4. Frontend shows scanned peer info and fee lines (2%).
     * 5. On Confirm, frontend POSTs to /api/payments/peer-deduct with:
     *    { payerId, payeeId, amount_small, currency, token }
     *
     * SECURITY:
     * - The server must validate the token, the payer's identity, check balances,
     *   apply fees, update ledger and return final status.
     * - The frontend MUST NOT attempt to change balances locally.
     *
     * Requirements:
     * - Browser with camera access.
     * - Backend endpoints: GET /api/me (optional), POST /api/payments/peer-deduct
     ************************************************************************/

    // ======= Configuration =======
    const FEE_PCT = 0.02; // 2% platform fee for display (server must compute & persist)
    const INITIATE_ENDPOINT = '/api/payments/peer-deduct'; // backend endpoint to perform deduction

    // ======= DOM =======
    const amountEl = document.getElementById('amount');
    const currencyEl = document.getElementById('currency');
    const feeDisplay = document.getElementById('feeDisplay');

    const startScanBtn = document.getElementById('startScan');
    const stopScanBtn = document.getElementById('stopScan');
    const cameraView = document.getElementById('cameraView');
    const captureCanvas = document.getElementById('captureCanvas');
    const scanStatus = document.getElementById('scanStatus');

    const peerCard = document.getElementById('peerCard');
    const peerIdEl = document.getElementById('peerId');
    const peerBalanceEl = document.getElementById('peerBalance');
    const grossDisplay = document.getElementById('grossDisplay');
    const netDisplay = document.getElementById('netDisplay');
    const confirmBtn = document.getElementById('confirmBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const actionStatus = document.getElementById('actionStatus');

    let videoStream = null;
    let scanning = false;
    let scanLoopHandle = null;
    let lastScanned = null; // prevent duplicate handling

    // BarcodeDetector availability
    const hasBarcodeDetector = ('BarcodeDetector' in window) && (typeof BarcodeDetector === 'function');
    // prefer QR format only
    const barcodeDetector = hasBarcodeDetector ? new BarcodeDetector({ formats: ['qr_code'] }) : null;

    // compute fee display when amount or currency changes
    function updateFeePreview() {
      const amt = Number(amountEl.value || 0);
      if (!amt || amt <= 0) {
        feeDisplay.textContent = '—';
        return;
      }
      const fee = roundTo2(amt * FEE_PCT);
      feeDisplay.textContent = `${currencyEl.value} ${fee.toFixed(2)}`;
    }
    amountEl.addEventListener('input', updateFeePreview);
    currencyEl.addEventListener('change', updateFeePreview);

    function roundTo2(n) { return Math.round((n + Number.EPSILON) * 100) / 100; }

    // convert to smallest unit integer (e.g. kobo/cents)
    function toSmallestUnit(amount) {
      const n = Number(amount || 0);
      return Math.round(n * 100);
    }

    // format smallest unit to currency string
    function fromSmallestUnit(small, currency) {
      try {
        return new Intl.NumberFormat(undefined, { style: 'currency', currency }).format(Number(small) / 100);
      } catch (e) {
        return (currency ? currency + ' ' : '') + (Number(small) / 100).toFixed(2);
      }
    }

    // ======= Scanner controls =======
    async function startCamera() {
      if (scanning) return;
      scanStatus.textContent = 'Requesting camera permission…';
      try {
        videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
        cameraView.srcObject = videoStream;
        await cameraView.play();
        scanning = true;
        startScanBtn.disabled = true;
        stopScanBtn.disabled = false;
        scanStatus.textContent = 'Scanning — point camera at peer QR';
        captureCanvas.width = cameraView.videoWidth || 640;
        captureCanvas.height = cameraView.videoHeight || 480;
        scanLoop();
      } catch (err) {
        console.error('camera start failed', err);
        scanStatus.textContent = 'Unable to access camera. Check permissions.';
        alert('Camera access is required to scan the peer QR code.');
      }
    }

    function stopCamera() {
      scanning = false;
      startScanBtn.disabled = false;
      stopScanBtn.disabled = true;
      scanStatus.textContent = 'Scanner stopped';
      if (scanLoopHandle) {
        cancelAnimationFrame(scanLoopHandle);
        scanLoopHandle = null;
      }
      if (videoStream) {
        videoStream.getTracks().forEach(t => t.stop());
        videoStream = null;
      }
    }

    async function scanLoop() {
      if (!scanning) return;
      try {
        // Prefer BarcodeDetector
        if (barcodeDetector) {
          try {
            const results = await barcodeDetector.detect(cameraView);
            if (results && results.length) {
              for (const r of results) {
                if (r.rawValue) {
                  handleScannedData(r.rawValue);
                  return; // stop scanning after first found
                }
              }
            }
          } catch (bdErr) {
            // some browsers throw - fall back to canvas approach
            // console.warn('BarcodeDetector error', bdErr);
            await canvasScanAndDecode();
          }
        } else {
          await canvasScanAndDecode();
        }
      } catch (err) {
        // swallow and continue
        console.warn('scanLoop error', err);
      }
      scanLoopHandle = requestAnimationFrame(scanLoop);
    }

    // Canvas scanning fallback using jsQR
    async function canvasScanAndDecode() {
      if (!cameraView || cameraView.readyState !== cameraView.HAVE_ENOUGH_DATA) return;
      const vw = cameraView.videoWidth;
      const vh = cameraView.videoHeight;
      if (!vw || !vh) return;
      captureCanvas.width = vw;
      captureCanvas.height = vh;
      const ctx = captureCanvas.getContext('2d');
      // mirror back again so coordinates match visual
      ctx.drawImage(cameraView, 0, 0, vw, vh);
      const imageData = ctx.getImageData(0, 0, vw, vh);
      const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "detectOnly" });
      if (code && code.data) {
        handleScannedData(code.data);
      }
    }

    // Handle scanned QR payload
    function handleScannedData(raw) {
      // avoid reprocessing same string repeatedly
      if (lastScanned && lastScanned === raw) return;
      lastScanned = raw;
      scanning = false;
      stopCamera();
      scanStatus.textContent = 'QR detected';

      // Try parsing as URL with cashcall:// or JSON
      let payload = null;
      try {
        // Accept cashcall://... or https://... with query params or pure JSON
        if (raw.trim().startsWith('{')) {
          payload = JSON.parse(raw);
        } else {
          // try URL parsing
          try {
            const u = new URL(raw);
            // if scheme is cashcall or contains query params
            if (u.protocol && (u.protocol.startsWith('cashcall') || u.searchParams)) {
              const params = {};
              u.searchParams.forEach((v,k) => params[k] = v);
              payload = params;
            } else {
              // fallback: not a cashcall URL — try JSON parse
              try { payload = JSON.parse(raw); } catch(e){ payload = null; }
            }
          } catch (e) {
            // not a URL — maybe key:value string or token
            try { payload = JSON.parse(raw); } catch (ee) { payload = null; }
          }
        }
      } catch (err) {
        console.warn('parse scan failed', err);
      }

      if (!payload || (!payload.userId && !payload.user_id && !payload.userid)) {
        scanStatus.textContent = 'Scanned data not recognised. Ask peer to show correct CashCall QR.';
        actionStatus.className = 'status err';
        actionStatus.textContent = 'Invalid QR content.';
        return;
      }

      // normalize keys
      const payeeId = payload.userId || payload.user_id || payload.userid || payload.user || null;
      const balanceSmall = typeof payload.balance_small !== 'undefined' ? Number(payload.balance_small) :
                           (typeof payload.balance !== 'undefined' ? toSmallestUnit(payload.balance) : null);
      const token = payload.token || payload.authToken || payload.t || null;

      // populate UI
      peerCard.style.display = 'block';
      peerIdEl.textContent = String(payeeId);
      if (balanceSmall != null) {
        peerBalanceEl.textContent = `Available: ${fromSmallestUnit(balanceSmall, currencyEl.value)}`;
      } else {
        peerBalanceEl.textContent = `Available: unknown`;
      }
      scanStatus.textContent = 'Peer scanned — verify and confirm amount below';

      // compute fee & net
      const amountMajor = Number(amountEl.value || 0);
      const grossSmall = toSmallestUnit(amountMajor);
      const feeSmall = Math.round(grossSmall * FEE_PCT);
      const netSmall = grossSmall - feeSmall;

      grossDisplay.textContent = fromSmallestUnit(grossSmall, currencyEl.value);
      netDisplay.textContent = `Net to deduct (gross − fee): ${fromSmallestUnit(netSmall, currencyEl.value)} (fee ${fromSmallestUnit(feeSmall, currencyEl.value)})`;

      // wire confirm
      confirmBtn.onclick = () => confirmAndDeduct({
        payeeId,
        balanceSmall,
        token,
        grossSmall,
        feeSmall,
        netSmall,
        currency: currencyEl.value
      });

      cancelBtn.onclick = () => {
        peerCard.style.display = 'none';
        actionStatus.style.display = 'none';
        lastScanned = null;
      };
    }

    // Confirm and send request to server to deduct peer wallet
    async function confirmAndDeduct({ payeeId, balanceSmall, token, grossSmall, feeSmall, netSmall, currency }) {
      actionStatus.style.display = 'none';
      // Minimal client-side checks
      if (!payeeId) {
        actionStatus.className = 'status err'; actionStatus.textContent = 'Missing payee id'; return;
      }
      if (!grossSmall || grossSmall <= 0) {
        actionStatus.className = 'status err'; actionStatus.textContent = 'Enter valid amount'; return;
      }
      // warn if peer balance known and insufficient
      if (balanceSmall != null && balanceSmall < grossSmall) {
        if (!confirm('Peer balance appears lower than amount. Proceed and let server decide?')) return;
      }

      // show progress
      confirmBtn.disabled = true;
      cancelBtn.disabled = true;
      actionStatus.className = 'status warn';
      actionStatus.textContent = 'Contacting server to perform deduction…';

      // Build payload for server
      // IMPORTANT: server must validate token, payer authorization, and actually debit payee wallet.
      const payload = {
        payeeId: String(payeeId),
        amount_small: grossSmall,
        currency,
        fee_small: feeSmall, // optional: server should compute itself
        token // ephemeral token from payee QR to authorize deduction request (server must validate)
        // payer must be authenticated — send auth token or rely on cookies
      };

      try {
        const resp = await fetch(INITIATE_ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
            // include Authorization header if using bearer tokens:
            // 'Authorization': 'Bearer ' + localStorage.getItem('cashcall_token')
          },
          credentials: 'include',
          body: JSON.stringify(payload)
        });

        if (!resp.ok) {
          const text = await resp.text().catch(()=>null);
          throw new Error(text || `Server error (${resp.status})`);
        }

        const json = await resp.json();
        // Expect server to return something like { success:true, withdrawal:..., transaction:..., message:... }
        if (json && (json.success || json.ok)) {
          actionStatus.className = 'status ok';
          actionStatus.textContent = json.message || 'Deduction successful';
          // Optionally redirect or refresh dashboard
          setTimeout(() => {
            window.location.href = 'dashboard.html';
          }, 1100);
        } else {
          const msg = (json && (json.message || JSON.stringify(json))) || 'Deduction failed';
          throw new Error(msg);
        }

      } catch (err) {
        console.error('deduct error', err);
        actionStatus.className = 'status err';
        actionStatus.textContent = 'Error: ' + (err.message || err);
      } finally {
        confirmBtn.disabled = false;
        cancelBtn.disabled = false;
      }
    }

    // Wire up start/stop buttons
    startScanBtn.addEventListener('click', async () => {
      lastScanned = null;
      actionStatus.style.display = 'none';
      peerCard.style.display = 'none';
      updateFeePreview();
      await startCamera();
    });

    stopScanBtn.addEventListener('click', () => {
      stopCamera();
    });

    // Cleanup camera on page leave
    window.addEventListener('pagehide', () => stopCamera());
    window.addEventListener('beforeunload', () => stopCamera());

    // initialize preview
    updateFeePreview();
  </script>
</body>
</html>