<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>CashCall â€” Dashboard</title>
  <meta name="description" content="CashCall dashboard â€” wallet balance, quick actions and transaction history." />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Manrope:wght@600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --maxw:420px;
      --bg-1:#eef6fb;
      --bg-2:#ffffff;
      --card:#ffffff;
      --muted:#50636f;
      --accent-a:#00bcd4;
      --accent-b:#8450ff;
      --radius:14px;
      --shadow: 0 20px 50px rgba(7,30,60,0.04);
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; padding:0; background: linear-gradient(180deg,var(--bg-1),var(--bg-2)); font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial; -webkit-font-smoothing:antialiased; color:#06202b}
    body{ padding:18px; -webkit-text-size-adjust:100% }

    .wrap{ max-width:var(--maxw); margin:0 auto; }

    header{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:12px; border-radius:12px; background:rgba(255,255,255,0.95);
      border:1px solid rgba(7,32,44,0.06); box-shadow:var(--shadow);
      position:sticky; top:12px; z-index:40;
    }
    .brand{ display:flex; gap:12px; align-items:center; min-width:0; }
    .logo{ width:48px; height:48px; border-radius:10px; display:grid; place-items:center; background:linear-gradient(90deg,var(--accent-a),var(--accent-b)); color:#021026; font-family:Manrope; font-weight:900; }
    .who { min-width:0; overflow:hidden; }
    .who .hi { margin:0; font-size:12px; color:var(--muted); }
    .who .name { margin:0; font-family:Manrope; font-weight:800; font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .hdr-actions { display:flex; gap:8px; align-items:center; }
    .btn-icon { width:40px; height:40px; display:grid; place-items:center; border-radius:10px; border:1px solid rgba(7,32,44,0.04); background:transparent; cursor:pointer; font-weight:700; color:var(--muted); }
    .btn-ghost { padding:8px 12px; border-radius:10px; background:transparent; border:1px solid rgba(7,32,44,0.04); color:var(--muted); cursor:pointer; font-weight:700 }

    main{ margin-top:12px; display:grid; gap:12px; }

    .card { background:var(--card); border-radius:14px; padding:14px; border:1px solid rgba(7,32,44,0.04); box-shadow:var(--shadow); }
    .label { color:var(--muted); font-size:13px; }
    .balance-row { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-top:6px; }
    .balance { font-family:Manrope; font-size:30px; font-weight:800; color:#021026; }
    .sub { font-size:12px; color:var(--muted); margin-top:6px; }

    .quick-actions { display:flex; gap:10px; margin-top:12px; }
    .action { flex:1; padding:12px; border-radius:12px; text-align:center; font-weight:800; cursor:pointer; border:0; color:#021026; background:linear-gradient(90deg,var(--accent-a),var(--accent-b)); }
    .action.ghost { background:transparent; border:1px solid rgba(7,32,44,0.06); color:var(--muted); font-weight:700 }

    .section-title { margin:2px 0 8px 2px; font-weight:800; font-family:Manrope; font-size:14px; color:#021026; }

    .history { display:flex; flex-direction:column; gap:10px; margin-bottom:8px; }
    .tx { display:flex; justify-content:space-between; gap:12px; align-items:center; padding:12px; border-radius:12px; background:linear-gradient(180deg,#fff,#fbfdff); border:1px solid rgba(7,32,44,0.03); }
    .tx-left { display:flex; gap:12px; align-items:center; min-width:0; }
    .tx-ico { width:48px; height:48px; border-radius:10px; display:grid; place-items:center; font-weight:900; color:#021026; background:linear-gradient(135deg, rgba(0,188,212,0.08), rgba(132,80,255,0.08)); }
    .tx-title { font-weight:800; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .tx-sub { font-size:12px; color:var(--muted); margin-top:4px; }
    .tx-right { text-align:right; min-width:96px; }
    .tx-amt { font-weight:800; font-size:15px; }
    .tx-time { font-size:12px; color:var(--muted); margin-top:4px; }

    .empty { padding:18px; border-radius:12px; text-align:center; color:var(--muted); border:1px dashed rgba(7,32,44,0.03); background:linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.5)); }

    footer{ margin-top:14px; text-align:center; font-size:13px; color:var(--muted); }

    @media (max-width:380px){
      .balance { font-size:24px; }
      .tx-right { min-width:84px; }
      .hdr-actions { gap:6px }
    }
  </style>
</head>
<body>
  <div class="wrap" role="document">
    <header role="banner" aria-label="Top bar">
      <div class="brand">
        <div class="logo" aria-hidden="true">C</div>
        <div class="who">
          <p class="hi">Welcome back</p>
          <p id="userName" class="name">User</p>
        </div>
      </div>

      <div class="hdr-actions" role="group" aria-label="Header actions">
        <button id="refreshBtn" class="btn-icon" title="Refresh">âŸ³</button>
        <button id="logoutBtn" class="btn-ghost" title="Log out">Log out</button>
      </div>
    </header>

    <main>
      <!-- Wallet card -->
      <section class="card" aria-labelledby="walletTitle">
        <div id="walletTitle" class="label">Wallet balance</div>
        <div class="balance-row">
          <div>
            <div id="walletCurrency" class="balance">â€”</div>
            <div id="walletSub" class="sub">Available</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end;">
            <a href="request.html" class="action" style="text-decoration:none;display:inline-block;padding:8px 12px;font-size:13px;">Request</a>
            <!-- Pay now opens payee QR generator so others can scan you (per request) -->
            <a href="payeeqr.html" class="action ghost" style="text-decoration:none;display:inline-block;padding:8px 12px;font-size:13px;">Pay (show QR)</a>
          </div>
        </div>

        <div class="quick-actions" style="margin-top:12px">
          <a href="withdrawal.html" class="action" style="text-decoration:none;display:inline-block;">Withdraw</a>
          <!-- Quick receive now opens pay.html (scanner) as requested -->
          <button id="receiveQuick" class="action ghost" style="display:inline-block;">Quick receive (Scan)</button>
        </div>
      </section>

      <!-- Recent activity -->
      <h2 class="section-title">Recent activity</h2>
      <section aria-live="polite">
        <div id="history" class="history" aria-label="Transaction history"></div>
        <div id="emptyState" class="empty" hidden>No transactions yet â€” create or receive a payment to get started.</div>
      </section>
    </main>

    <footer>
      <div id="accountMeta"></div>
    </footer>
  </div>

  <script>
    /**
     * dashboard.html (updated)
     *
     * Changes:
     * - Pay link -> payeeqr.html (show your QR to payer)
     * - Quick receive -> opens pay.html scanner (instead of demo credit)
     * - Withdraw -> withdrawal.html (unchanged)
     * - Award new users 100 units (in their wallet currency) once, using per-user localStorage flag
     *
     * Storage keys used by other pages:
     * - cashcall_token
     * - cashcall_user (JSON)
     * - cashcall_wallet (JSON)  { userId, currency, balance (major string), balance_small (int) }
     * - cashcall_history (array of tx)
     * - cashcall_reward_granted_<userId>  (flag)
     */

    const TOKEN_KEY = 'cashcall_token';
    const USER_KEY = 'cashcall_user';
    const WALLET_KEY = 'cashcall_wallet';
    const HISTORY_KEY = 'cashcall_history'; // array of tx objects

    // Helper: read session (prefer localStorage)
    function readSession(){
      let token = localStorage.getItem(TOKEN_KEY);
      let user = localStorage.getItem(USER_KEY);
      let wallet = localStorage.getItem(WALLET_KEY);
      if (!token) {
        token = sessionStorage.getItem(TOKEN_KEY);
        user = sessionStorage.getItem(USER_KEY);
        wallet = sessionStorage.getItem(WALLET_KEY);
      }
      if (!token || !user || !wallet) return null;
      try {
        return { token, user: JSON.parse(user), wallet: JSON.parse(wallet) };
      } catch (err) {
        // corrupted -> clear
        localStorage.removeItem(TOKEN_KEY); localStorage.removeItem(USER_KEY); localStorage.removeItem(WALLET_KEY);
        sessionStorage.removeItem(TOKEN_KEY); sessionStorage.removeItem(USER_KEY); sessionStorage.removeItem(WALLET_KEY);
        return null;
      }
    }

    // Format currency safely using Intl; fall back to basic formatting
    function formatCurrency(amountSmall, currency){
      // amountSmall: integer smallest units (e.g. kobo/cents)
      try {
        const major = (Number(amountSmall) / 100).toFixed(2);
        return new Intl.NumberFormat(undefined, { style: 'currency', currency }).format(Number(major));
      } catch (e) {
        return (currency ? currency + ' ' : '') + (Number(amountSmall) / 100).toFixed(2);
      }
    }

    // Read history (array)
    function loadHistory(){
      try { return JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]'); }
      catch (e) { return []; }
    }
    function saveHistory(arr){ localStorage.setItem(HISTORY_KEY, JSON.stringify(arr || [])); }

    // Render header user/wallet info
    function renderHeader(session){
      const userName = document.getElementById('userName');
      const accountMeta = document.getElementById('accountMeta');
      userName.textContent = session.user.name || session.user.email || 'User';
      accountMeta.textContent = `${session.user.email || ''}${session.user.country ? ' â€¢ ' + session.user.country.toUpperCase() : ''}`;
    }

    function renderWallet(session){
      const walletCurrency = document.getElementById('walletCurrency');
      const walletSub = document.getElementById('walletSub');
      const w = session.wallet || { balance: 0, currency: 'USD' };
      // wallet.balance may be stored as major or smallest unit. Normalize:
      let balanceSmall = null;
      if (typeof w.balance === 'number') {
        if (w.balance_small != null) balanceSmall = Number(w.balance_small);
        else balanceSmall = Math.round(Number(w.balance) * 100);
      } else {
        const n = parseFloat(String(w.balance || '0').replace(/,/g,''));
        balanceSmall = Math.round(n * 100);
      }
      walletCurrency.textContent = formatCurrency(balanceSmall, w.currency || 'USD');
      walletSub.textContent = `Available â€¢ ${w.currency || 'USD'}`;
    }

    // Render transactions list
    function renderHistory(){
      const list = document.getElementById('history');
      const emptyState = document.getElementById('emptyState');
      list.innerHTML = '';

      let txs = loadHistory();
      if (!txs.length) {
        emptyState.hidden = false;
        return;
      } else {
        emptyState.hidden = true;
      }

      // show newest first
      txs.slice().reverse().forEach(tx => {
        const el = document.createElement('div');
        el.className = 'tx';

        // determine icon for type
        const ico = document.createElement('div');
        ico.className = 'tx-ico';
        ico.setAttribute('aria-hidden','true');
        if (tx.type === 'credit') ico.textContent = 'ï¼‹';
        else if (tx.type === 'debit') ico.textContent = 'âˆ’';
        else if (tx.type === 'request') ico.textContent = 'ðŸ”—';
        else ico.textContent = 'â€¢';

        const left = document.createElement('div');
        left.className = 'tx-left';
        const meta = document.createElement('div');
        meta.style.minWidth = '0';
        const title = document.createElement('div');
        title.className = 'tx-title';
        title.textContent = tx.title || (tx.type === 'credit' ? 'Received' : 'Transaction');

        const sub = document.createElement('div');
        sub.className = 'tx-sub';
        const subParts = [];
        if (tx.subtitle) subParts.push(tx.subtitle);
        if (tx.requestId) subParts.push('Req: ' + tx.requestId);
        if (tx.status) subParts.push(tx.status);
        sub.textContent = subParts.join(' â€¢ ');

        meta.appendChild(title);
        meta.appendChild(sub);
        left.appendChild(ico);
        left.appendChild(meta);

        const right = document.createElement('div');
        right.className = 'tx-right';
        // display gross, fee, net if present
        const amt = document.createElement('div');
        amt.className = 'tx-amt';
        // tx.gross_small, tx.fee_small, tx.net_small integers expected. fallback to tx.amount
        let grossSmall = null;
        if (tx.gross_small != null) grossSmall = Number(tx.gross_small);
        else if (tx.amount_small != null) grossSmall = Number(tx.amount_small);
        else if (tx.amount != null) grossSmall = Math.round(Number(tx.amount) * 100);
        else grossSmall = 0;

        let feeSmall = (tx.fee_small != null) ? Number(tx.fee_small) : (tx.fee != null ? Math.round(Number(tx.fee) * 100) : null);
        let netSmall = (tx.net_small != null) ? Number(tx.net_small) : (tx.net != null ? Math.round(Number(tx.net) * 100) : null);

        if (feeSmall != null && netSmall == null) netSmall = grossSmall - feeSmall;
        if (netSmall == null) netSmall = grossSmall;

        amt.textContent = formatCurrency((tx.type === 'debit' ? -grossSmall : grossSmall), tx.currency || 'USD');

        const time = document.createElement('div');
        time.className = 'tx-time';
        time.textContent = tx.time ? timeAgo(new Date(tx.time)) : (tx.createdAt ? timeAgo(new Date(tx.createdAt)) : '');

        right.appendChild(amt);
        if (feeSmall != null) {
          const feeLine = document.createElement('div');
          feeLine.style.fontSize = '12px';
          feeLine.style.color = 'var(--muted)';
          feeLine.textContent = `Fee ${formatCurrency(feeSmall, tx.currency || 'USD')} â€¢ Net ${formatCurrency(netSmall, tx.currency || 'USD')}`;
          right.appendChild(feeLine);
        }

        right.appendChild(time);

        el.appendChild(left);
        el.appendChild(right);
        list.appendChild(el);
      });
    }

    // helpers
    function timeAgo(date) {
      const diff = Date.now() - date.getTime();
      const s = Math.floor(diff / 1000);
      if (s < 60) return s + 's';
      const m = Math.floor(s / 60);
      if (m < 60) return m + 'm';
      const h = Math.floor(m / 60);
      if (h < 24) return h + 'h';
      const d = Math.floor(h / 24);
      return d + 'd';
    }

    // Add demo transaction and credit wallet (used by Quick Receive previously)
    function addDemoTransaction(tx) {
      const cur = loadHistory();
      cur.push(tx);
      saveHistory(cur);
      renderHistory();
    }

    function updateWalletBalance(amountDeltaSmall) {
      // amountDeltaSmall integer (can be negative). Update whichever storage currently used.
      let token = localStorage.getItem(TOKEN_KEY);
      let userStr = localStorage.getItem(USER_KEY);
      let walletStr = localStorage.getItem(WALLET_KEY);
      const useLocal = !!token && !!userStr && !!walletStr;

      if (!useLocal) {
        token = sessionStorage.getItem(TOKEN_KEY);
        userStr = sessionStorage.getItem(USER_KEY);
        walletStr = sessionStorage.getItem(WALLET_KEY);
      }
      if (!walletStr) return;

      try {
        const walletObj = JSON.parse(walletStr);
        let balanceSmall = null;
        if (walletObj.balance_small != null) balanceSmall = Number(walletObj.balance_small);
        else balanceSmall = Math.round(Number(walletObj.balance || 0) * 100);

        balanceSmall = Number(balanceSmall) + Number(amountDeltaSmall);

        walletObj.balance_small = Math.round(balanceSmall);
        walletObj.balance = (walletObj.balance_small / 100).toFixed(2);

        if (useLocal) localStorage.setItem(WALLET_KEY, JSON.stringify(walletObj));
        else sessionStorage.setItem(WALLET_KEY, JSON.stringify(walletObj));
        // re-render wallet
        const session = readSession();
        if (session) {
          // refresh session.wallet from storage
          const freshWallet = useLocal ? JSON.parse(localStorage.getItem(WALLET_KEY)) : JSON.parse(sessionStorage.getItem(WALLET_KEY));
          session.wallet = freshWallet;
          renderWallet(session);
        } else {
          // fallback: attempt to render from walletObj
          document.getElementById('walletCurrency').textContent = formatCurrency(walletObj.balance_small, walletObj.currency || 'USD');
        }
      } catch (err) {
        console.warn('update wallet failed', err);
      }
    }

    // Logout
    function clearSessionAndRedirect() {
      localStorage.removeItem(TOKEN_KEY);
      localStorage.removeItem(USER_KEY);
      localStorage.removeItem(WALLET_KEY);
      sessionStorage.removeItem(TOKEN_KEY);
      sessionStorage.removeItem(USER_KEY);
      sessionStorage.removeItem(WALLET_KEY);
      window.location.href = 'index.html';
    }

    // Utility: convert major (string/number) to smallest integer
    function majorToSmall(major) {
      const n = typeof major === 'number' ? major : parseFloat(String(major || '0').replace(/,/g,''));
      if (isNaN(n)) return 0;
      return Math.round(n * 100);
    }

    // grant welcome reward of 100 units in user's wallet currency (only once per user)
    function grantWelcomeRewardOnce(session) {
      if (!session || !session.user || !session.wallet) return;
      const userId = session.user.id || session.user.email || session.user.name;
      if (!userId) return;

      const flagKey = `cashcall_reward_granted_${userId}`;
      if (localStorage.getItem(flagKey)) return; // already given

      // decide 100 in the wallet currency
      const rewardMajor = 100; // 100 units of their chosen currency
      const rewardSmall = majorToSmall(rewardMajor);

      // create tx: credit gross = reward, fee = 0, net = reward
      const tx = {
        id: 'reward_' + Date.now() + '_' + Math.random().toString(36).slice(2,6),
        type: 'credit',
        title: 'Welcome reward',
        subtitle: `Sign-up reward â€” ${rewardMajor} ${session.wallet.currency}`,
        gross_small: rewardSmall,
        fee_small: 0,
        net_small: rewardSmall,
        currency: session.wallet.currency || 'USD',
        time: new Date().toISOString(),
        status: 'settled'
      };

      // persist tx and update wallet
      addDemoTransaction(tx);
      updateWalletBalance(rewardSmall);

      // set flag
      localStorage.setItem(flagKey, new Date().toISOString());
      console.info(`Granted welcome reward ${rewardMajor} ${session.wallet.currency} to ${userId}`);
    }

    // Initialize dashboard
    (function init(){
      const session = readSession();
      if (!session) {
        // not logged in -> redirect to login
        window.location.href = 'login.html';
        return;
      }
      renderHeader(session);
      renderWallet(session);
      renderHistory();

      // if wallet appears newly created (balance small missing or zero) or reward not given, grant welcome reward
      try {
        // grant reward if not given before
        grantWelcomeRewardOnce(session);
      } catch (err) {
        console.warn('welcome reward failed', err);
      }

      // wire buttons
      document.getElementById('logoutBtn').addEventListener('click', () => {
        clearSessionAndRedirect();
      });

      document.getElementById('refreshBtn').addEventListener('click', () => {
        const s = readSession();
        if (!s) { window.location.href = 'login.html'; return; }
        renderWallet(s);
        renderHistory();
      });

      // Quick receive now opens pay.html (scanner) per user request
      document.getElementById('receiveQuick').addEventListener('click', () => {
        // open pay.html (scanner) so user can scan a payer's QR to receive
        window.location.href = 'pay.html';
      });
    })();

    // If no history exists, seed a tiny demo transaction for nicer UX (optional)
    (function seedDemoIfEmpty(){
      const h = loadHistory();
      if (!h.length) {
        const session = readSession();
        const currency = (session && session.wallet && session.wallet.currency) || 'USD';
        const seed = {
          id: 'seed_' + Date.now(),
          type: 'credit',
          title: 'Welcome bonus (seed)',
          subtitle: 'Thanks for signing up',
          gross_small: 1000,    // 10.00 in major unit
          fee_small: Math.round(1000 * 2 / 100),
          net_small: 1000 - Math.round(1000 * 2 / 100),
          currency,
          time: new Date().toISOString(),
          status: 'settled'
        };
        saveHistory([seed]);
        // Also ensure wallet has some balance: if wallet exists, add seed amount
        try {
          const s = readSession();
          if (s) {
            // credit wallet with net_small
            updateWalletBalance(seed.net_small);
          }
        } catch(e){}
      }
    })();
  </script>
</body>
</html>